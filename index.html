<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Xmas Flappy Reindeer - Somnia</title>

  <!-- VIEM ke window.viem -->
  <script type="module">
    import {
      createPublicClient,
      createWalletClient,
      custom,
      http,
      encodeFunctionData,
    } from "https://cdn.jsdelivr.net/npm/viem@2.0.0/+esm";

    window.viem = {
      createPublicClient,
      createWalletClient,
      custom,
      http,
      encodeFunctionData,
    };
  </script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#0a1a3f; overflow:hidden; font-family:Arial, sans-serif; color:white; }
    canvas { display:block; margin:0 auto; }

    #ui {
      position:absolute;
      top:20px;
      left:20px;
      z-index:10;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    #top-buttons {
      position:absolute;
      top:20px;
      right:20px;
      z-index:10;
      display:flex;
      gap:10px;
    }

    #leaderboard {
      position:absolute;
      top:80px;
      right:20px;
      background:rgba(0,0,0,0.85);
      padding:15px;
      border-radius:10px;
      max-width:280px;
      display:none;
      z-index:12;
    }

    /* tombol submit di tengah atas biar pasti kelihatan */
    #submit-box {
      position:absolute;
      top:70px;
      left:50%;
      transform:translateX(-50%);
      z-index:11;
    }

    button {
      padding:10px 16px;
      font-size:14px;
      background:#c41e3a;
      color:white;
      border:none;
      border-radius:8px;
      cursor:pointer;
      white-space:nowrap;
    }

    h2,h3 { margin:0; }
    ol { font-size:13px; padding-left:18px; margin:8px 0 0; }

    #copyright {
      position:fixed;
      bottom:8px;
      left:50%;
      transform:translateX(-50%);
      font-size:11px;
      color:#ccc;
      background:rgba(0,0,0,0.5);
      padding:4px 8px;
      border-radius:6px;
      z-index:5;
    }

    @media (max-width:480px){
      #ui { left:10px; top:10px; }
      #top-buttons { right:10px; top:10px; }
      #leaderboard { right:10px; top:65px; max-width:260px; }
      #submit-box { top:65px; }
      #copyright { font-size:10px; bottom:4px; }
    }
  </style>
</head>
<body>
  <div id="ui">
    <button id="connect">Connect Wallet</button>
    <h2>Score: <span id="score">0</span></h2>
    <h3>Best: <span id="best">0</span></h3>
  </div>

  <div id="top-buttons">
    <button id="toggle-lb">Top 10 Flyers</button>
  </div>

  <div id="submit-box">
    <button id="submit-score" style="display:none;">Save Score On-Chain</button>
  </div>

  <canvas id="game" width="400" height="600"></canvas>

  <div id="leaderboard">
    <h3>Top 10 Flyers</h3>
    <ol id="lb-list"></ol>
  </div>

  <div id="copyright">
    © 2024 Xmas Flappy Reindeer — deployed by @hc7690 (Discord)
  </div>

  <script type="module">
    const CONTRACT_ADDRESS = "0xCA1B72f663E1303d75aB1f8edbc2A6eeF3026347";

    const ABI = [
      {
        inputs:[{ internalType:"uint256", name:"_score", type:"uint256" }],
        name:"submitScore",
        outputs:[],
        stateMutability:"nonpayable",
        type:"function"
      },
      {
        inputs:[],
        name:"getLeaderboard",
        outputs:[{
          components:[
            { internalType:"address", name:"player", type:"address" },
            { internalType:"uint256", name:"score", type:"uint256" },
            { internalType:"uint256", name:"timestamp", type:"uint256" }
          ],
          internalType:"struct XmasFlappyLeaderboard.Player[]",
          name:"",
          type:"tuple[]"
        }],
        stateMutability:"view",
        type:"function"
      },
      {
        inputs:[{ internalType:"address", name:"player", type:"address" }],
        name:"getPlayerBest",
        outputs:[{ internalType:"uint256", name:"", type:"uint256" }],
        stateMutability:"view",
        type:"function"
      }
    ];

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const submitBtn = document.getElementById("submit-score");

    let score = 0;
    let best = 0;
    let gameOver = true;
    let started = false;

    let bird = { x: 100, y: 300, vy: 0 };
    let pipes = [];
    let snowflakes = [];
    let frame = 0;

    let playerBest = 0;    // best score on-chain
    let walletClient, publicClient, account;
    let walletConnected = false;

    const somnia = {
      id: 5031n,
      name: "Somnia Mainnet",
      rpcUrls: {
        default: {
          http: ["https://api.infra.mainnet.somnia.network"],
        },
      },
    };

    const PIPE_SPEED = 1.5;
    const GRAVITY = 0.35;
    const FLAP_POWER = -8.5;
    const PIPE_GAP = 200;
    const PIPE_INTERVAL = 130;

    function drawReindeer(x, y) {
      ctx.save();
      ctx.translate(x, y);

      ctx.fillStyle = "#8B4513";
      ctx.beginPath();
      ctx.ellipse(0, 0, 22, 16, 0, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = "#D2691E";
      ctx.beginPath();
      ctx.arc(-12, -3, 10, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = "white";
      ctx.beginPath();
      ctx.arc(-16, -4, 3, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(-8, -4, 3, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = "black";
      ctx.beginPath();
      ctx.arc(-16, -5, 1.5, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(-8, -5, 1.5, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = "#FF0000";
      ctx.beginPath();
      ctx.arc(-3, 0, 5, 0, Math.PI * 2);
      ctx.fill();

      ctx.strokeStyle = "#DAA520";
      ctx.lineWidth = 4;
      ctx.lineCap = "round";
      ctx.beginPath();
      ctx.moveTo(-20, -10);
      ctx.lineTo(-28, -22);
      ctx.lineTo(-25, -28);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(-14, -10);
      ctx.lineTo(-22, -24);
      ctx.lineTo(-19, -30);
      ctx.stroke();

      ctx.restore();
    }

    function drawCandyPipe(x, y, w, h) {
      ctx.fillStyle = "#228B22";
      ctx.fillRect(x, y, w, h);

      ctx.fillStyle = "#DC143C";
      for (let i = 0; i < h; i += 25) {
        ctx.fillRect(x, y + i, w, 12);
      }

      ctx.strokeStyle = "white";
      ctx.lineWidth = 5;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.beginPath();
      ctx.moveTo(x + 15, y + 15);
      ctx.quadraticCurveTo(x + 35, y + h / 2, x + 15, y + h - 15);
      ctx.stroke();
    }

    function drawBackground() {
      const grad = ctx.createLinearGradient(0, 0, 0, 600);
      grad.addColorStop(0, "#0a1a3f");
      grad.addColorStop(0.5, "#1e3a8a");
      grad.addColorStop(1, "#16213e");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, 400, 600);

      ctx.fillStyle = "#fff";
      for (let i = 0; i < 40; i++) {
        ctx.fillRect((i * 137.5) % 400, (i * 61) % 400, 2, 2);
      }
    }

    function drawStart() {
      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.fillRect(50, 150, 300, 300);
      ctx.fillStyle = "#FFD700";
      ctx.font = "bold 32px Arial";
      ctx.textAlign = "center";
      ctx.fillText("Xmas Flappy", 200, 220);
      ctx.font = "bold 28px Arial";
      ctx.fillText("Reindeer", 200, 260);
      ctx.fillStyle = "white";
      ctx.font = "20px Arial";
      ctx.fillText("Connect wallet to play!", 200, 320);
      ctx.fillText("Click/Space after connect", 200, 355);
    }

    function drawGameOver() {
      ctx.fillStyle = "rgba(0,0,0,0.8)";
      ctx.fillRect(40, 120, 320, 360);
      ctx.fillStyle = "#c41e3a";
      ctx.font = "bold 36px Arial";
      ctx.textAlign = "center";
      ctx.fillText("Game Over", 200, 190);
      ctx.fillStyle = "white";
      ctx.font = "bold 24px Arial";
      ctx.fillText(`Score: ${score}`, 200, 240);
      ctx.fillText(`Best: ${best}`, 200, 275);
      ctx.font = "20px Arial";
      ctx.fillText("Click/Space Restart", 200, 330);
    }

    function gameLoop() {
      ctx.clearRect(0, 0, 400, 600);
      frame++;

      drawBackground();

      if (frame % 2 === 0) {
        snowflakes.push({
          x: Math.random() * 400,
          y: -5,
          s: Math.random() * 3 + 1.5,
          vy: Math.random() * 0.5 + 0.5,
        });
      }

      snowflakes = snowflakes.filter((s) => {
        s.y += s.vy;
        s.x += Math.sin(frame * 0.01 + s.y) * 0.3;
        return s.y < 610;
      });

      snowflakes.forEach((s) => {
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.s, 0, Math.PI * 2);
        ctx.fill();
      });

      if (!started) {
        drawStart();
        submitBtn.style.display = "none";
        requestAnimationFrame(gameLoop);
        return;
      }

      if (gameOver) {
        drawGameOver();

        // tampilkan tombol submit kalau syarat terpenuhi
        if (walletConnected && score > playerBest) {
          submitBtn.style.display = "inline-block";
        } else {
          submitBtn.style.display = "none";
        }

        requestAnimationFrame(gameLoop);
        return;
      }

      submitBtn.style.display = "none";

      bird.vy *= 0.95;
      bird.vy += GRAVITY;
      bird.y += bird.vy;

      if (bird.y < 20 || bird.y > 560) gameOver = true;

      drawReindeer(bird.x, bird.y);

      if (frame % PIPE_INTERVAL === 0) {
        const gapTop = 80 + Math.random() * 220;
        pipes.push({
          x: 410,
          top: gapTop,
          bottom: 600 - gapTop - PIPE_GAP,
          passed: false,
        });
      }

      pipes = pipes.filter((p) => {
        p.x -= PIPE_SPEED;

        if (p.x < -70) return false;

        if (p.x + 70 < bird.x && !p.passed) {
          score++;
          document.getElementById("score").textContent = score;
          p.passed = true;
        }

        if (
          bird.x < p.x + 65 &&
          bird.x + 40 > p.x &&
          (bird.y < p.top || bird.y + 40 > p.top + PIPE_GAP)
        ) {
          gameOver = true;
        }

        drawCandyPipe(p.x, 0, 65, p.top);
        drawCandyPipe(p.x, p.top + PIPE_GAP, 65, p.bottom);

        return true;
      });

      if (score > best) {
        best = score;
        document.getElementById("best").textContent = best;
      }

      requestAnimationFrame(gameLoop);
    }

    function flap() {
      if (!walletConnected) {
        alert("Please connect your Somnia wallet first to play.");
        return;
      }

      if (!started) {
        started = true;
        gameOver = false;
        return;
      }

      if (gameOver) {
        bird.y = 300;
        bird.vy = 0;
        score = 0;
        pipes = [];
        snowflakes = [];
        document.getElementById("score").textContent = "0";
        gameOver = false;
        submitBtn.style.display = "none";
        return;
      }

      bird.vy = FLAP_POWER;
    }

    canvas.addEventListener("click", flap);
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space") {
        e.preventDefault();
        flap();
      }
    });

    document.getElementById("toggle-lb").onclick = () => {
      const box = document.getElementById("leaderboard");
      const willShow =
        box.style.display === "none" || box.style.display === "";
      box.style.display = willShow ? "block" : "none";
      if (willShow) loadLeaderboard();
    };

    document.getElementById("connect").onclick = async () => {
      if (!window.viem) return alert("Loading... coba lagi");
      const { createWalletClient, custom, createPublicClient, http } = window.viem;

      if (!window.ethereum) return alert("Install MetaMask dulu, bro!");

      try {
        walletClient = createWalletClient({
          chain: somnia,
          transport: custom(window.ethereum),
        });

        await walletClient.switchChain({ id: 5031n });

        [account] = await walletClient.requestAddresses();

        publicClient = createPublicClient({
          chain: somnia,
          transport: http(somnia.rpcUrls.default.http[0]),
        });

        if (account && account.length > 10) {
          walletConnected = true;

          document.getElementById("connect").textContent =
            `${account.slice(0, 6)}...${account.slice(-4)}`;

          playerBest = Number(
            await publicClient.readContract({
              address: CONTRACT_ADDRESS,
              abi: ABI,
              functionName: "getPlayerBest",
              args: [account],
            })
          );

          best = Math.max(best, playerBest);
          document.getElementById("best").textContent = best;
        } else {
          alert("Wallet connect gagal");
        }
      } catch (e) {
        console.error(e);
        alert(`Connect error: ${e.message}`);
      }
    };

    async function loadLeaderboard() {
      if (!publicClient) return;
      try {
        const lb = await publicClient.readContract({
          address: CONTRACT_ADDRESS,
          abi: ABI,
          functionName: "getLeaderboard",
        });

        const list = document.getElementById("lb-list");
        list.innerHTML = "";

        if (!lb || lb.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No scores on chain yet.";
          list.appendChild(li);
          return;
        }

        lb.slice(0, 10).forEach((p, i) => {
          const addr = String(p[0]);
          const short = addr.slice(0, 6) + "..." + addr.slice(-4);
          const li = document.createElement("li");
          li.textContent = `${i + 1}. ${short} — ${Number(p[1])} pts`;
          list.appendChild(li);
        });
      } catch (e) {
        console.error("loadLeaderboard error", e);
        const list = document.getElementById("lb-list");
        list.innerHTML = "";
        const li = document.createElement("li");
        li.textContent = "Failed to load leaderboard.";
        list.appendChild(li);
      }
    }

    async function submitScoreToChain() {
      if (!walletConnected || !window.ethereum) {
        alert("Wallet not connected.");
        return;
      }
      if (score <= playerBest) {
        alert("Your score is not higher than your best on-chain score.");
        return;
      }

      const ok = confirm(`Submit score ${score} to on-chain leaderboard?`);
      if (!ok) return;

      try {
        const { encodeFunctionData } = window.viem;
        const data = encodeFunctionData({
          abi: ABI,
          functionName: "submitScore",
          args: [BigInt(score)],
        });

        const txHash = await window.ethereum.request({
          method: "eth_sendTransaction",
          params: [
            {
              from: account,
              to: CONTRACT_ADDRESS,
              data,
            },
          ],
        });

        alert(`Score ${score} submitted! Tx: ${txHash.slice(0, 12)}...`);
        playerBest = score;
        best = Math.max(best, playerBest);
        document.getElementById("best").textContent = best;
        await loadLeaderboard();
      } catch (e) {
        console.error(e);
        alert(`Submit gagal: ${e.message}`);
      }
    }

    submitBtn.onclick = submitScoreToChain;

    gameLoop();
  </script>
</body>
</html>