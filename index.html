<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Xmas Flappy Santa - Somnia</title>

  <!-- VIEM ke window.viem -->
  <script type="module">
    import {
      createPublicClient,
      createWalletClient,
      custom,
      http,
      encodeFunctionData,
    } from "https://cdn.jsdelivr.net/npm/viem@2.0.0/+esm";

    window.viem = {
      createPublicClient,
      createWalletClient,
      custom,
      http,
      encodeFunctionData,
    };
  </script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#0a1a3f;
      overflow:hidden;
      font-family:Arial, sans-serif;
      color:white;
    }

    /* canvas responsive: logic 400x600, skala di layar */
    #canvas-wrapper{
      width:100%;
      max-width:420px;
      margin:0 auto;
      padding-top:60px;
      padding-bottom:60px;
    }
    canvas {
      display:block;
      margin:0 auto;
      width:100%;
      height:auto;
      border-radius:12px;
    }

    #ui {
      position:fixed;
      top:10px;
      left:10px;
      z-index:10;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    #top-buttons {
      position:fixed;
      top:10px;
      right:10px;
      z-index:10;
      display:flex;
      gap:10px;
    }

    #leaderboard {
      position:fixed;
      top:70px;
      right:10px;
      background:rgba(0,0,0,0.85);
      padding:15px;
      border-radius:10px;
      max-width:280px;
      display:none;
      z-index:12;
    }

    /* tombol submit di tengah atas */
    #submit-box {
      position:fixed;
      top:55px;
      left:50%;
      transform:translateX(-50%);
      z-index:11;
    }

    button {
      padding:8px 14px;
      font-size:14px;
      background:#c41e3a;
      color:white;
      border:none;
      border-radius:999px;
      cursor:pointer;
      white-space:nowrap;
    }

    h2,h3 { margin:0; text-shadow:0 0 4px rgba(0,0,0,0.7); }
    ol { font-size:13px; padding-left:18px; margin:8px 0 0; }

    #copyright {
      position:fixed;
      bottom:8px;
      left:50%;
      transform:translateX(-50%);
      font-size:11px;
      color:#ccc;
      background:rgba(0,0,0,0.5);
      padding:4px 8px;
      border-radius:6px;
      z-index:5;
    }

    @media (min-width:768px){
      #canvas-wrapper{ padding-top:80px; padding-bottom:80px; }
      button{ font-size:15px; }
    }
  </style>
</head>
<body>
  <div id="ui">
    <button id="connect">Connect Wallet</button>
    <h2>Score: <span id="score">0</span></h2>
    <h3>Best: <span id="best">0</span></h3>
  </div>

  <div id="top-buttons">
    <button id="toggle-lb">Top 10 Flyers</button>
  </div>

  <div id="submit-box">
    <button id="submit-score" style="display:none;">Save Score On-Chain</button>
  </div>

  <div id="canvas-wrapper">
    <canvas id="game" width="400" height="600"></canvas>
  </div>

  <div id="leaderboard">
    <h3>Top 10 Flyers</h3>
    <ol id="lb-list"></ol>
  </div>

  <div id="copyright">
    © 2024 Xmas Flappy Reindeer — deployed by @hc7690 (Discord)
  </div>

  <script type="module">
    const CONTRACT_ADDRESS = "0xCA1B72f663E1303d75aB1f8edbc2A6eeF3026347";

    const ABI = [
      {
        inputs:[{ internalType:"uint256", name:"_score", type:"uint256" }],
        name:"submitScore",
        outputs:[],
        stateMutability:"nonpayable",
        type:"function"
      },
      {
        inputs:[],
        name:"getLeaderboard",
        outputs:[{
          components:[
            { internalType:"address", name:"player", type:"address" },
            { internalType:"uint256", name:"score", type:"uint256" },
            { internalType:"uint256", name:"timestamp", type:"uint256" }
          ],
          internalType:"struct XmasFlappyLeaderboard.Player[]",
          name:"",
          type:"tuple[]"
        }],
        stateMutability:"view",
        type:"function"
      },
      {
        inputs:[{ internalType:"address", name:"player", type:"address" }],
        name:"getPlayerBest",
        outputs:[{ internalType:"uint256", name:"", type:"uint256" }],
        stateMutability:"view",
        type:"function"
      }
    ];

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const submitBtn = document.getElementById("submit-score");

    let score = 0;
    let best = 0;
    let gameOver = true;
    let started = false;

    let bird = { x: 110, y: 300, vy: 0 };
    let pipes = [];
    let snowflakes = [];
    let frame = 0;

    let playerBest = 0;    // best score on-chain
    let walletClient, publicClient, account;
    let walletConnected = false;

    const somnia = {
      id: 5031n,
      name: "Somnia Mainnet",
      rpcUrls: {
        default: {
          http: ["https://api.infra.mainnet.somnia.network"],
        },
      },
    };

    // === GAME SPEED TUNING (diperlambat) ===
    const PIPE_SPEED = 1.0;
    const GRAVITY = 0.28;
    const FLAP_POWER = -7.8;
    const PIPE_GAP = 210;
    const PIPE_INTERVAL = 150;

    // ==== ASSETS: IMAGE + SOUND ====

    // Santa image (santa.png di folder yang sama)
    const santaImg = new Image();
    santaImg.src = "santa.png";
    let santaLoaded = false;
    santaImg.onload = () => { santaLoaded = true; };

    // Audio (pastikan file ada, kalau nggak cuma silent)
    let bgMusic, flapSound, hitSound, scoreSound;
    let musicStarted = false;

    function safeAudio(src, loop=false, volume=1){
      const a = new Audio();
      a.src = src;
      a.loop = loop;
      a.volume = volume;
      return a;
    }

    try {
      bgMusic    = safeAudio("bg-music.mp3", true, 0.4);
      flapSound  = safeAudio("flap.wav", false, 0.7);
      hitSound   = safeAudio("hit.wav", false, 0.9);
      scoreSound = safeAudio("score.wav", false, 0.7);
    } catch(e) {
      console.warn("Audio init error", e);
    }

    function playSafe(audioObj){
      if (!audioObj) return;
      const a = audioObj.cloneNode(); // biar bisa overlap
      a.volume = audioObj.volume;
      a.play().catch(()=>{});
    }

    function startMusicOnce(){
      if (musicStarted || !bgMusic) return;
      musicStarted = true;
      bgMusic.play().catch(()=>{ /* user bisa trigger lagi */ });
    }

    // ===== DRAWING FUNCTIONS =====

    // fallback vector sleigh (kalau gambar belum load)
    function drawSantaVector(x, y) {
      ctx.save();
      ctx.translate(x, y);

      ctx.fillStyle = "#B22222";
      ctx.beginPath();
      ctx.moveTo(-30, 15);
      ctx.lineTo(20, 15);
      ctx.lineTo(26, 5);
      ctx.lineTo(-24, 5);
      ctx.closePath();
      ctx.fill();

      ctx.fillStyle = "#8B0000";
      ctx.fillRect(-26, 5, 8, 10);

      ctx.strokeStyle = "#FFD700";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(-30, 15);
      ctx.lineTo(20, 15);
      ctx.stroke();

      ctx.strokeStyle = "#C0C0C0";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(-28, 18);
      ctx.quadraticCurveTo(-20, 24, -10, 22);
      ctx.quadraticCurveTo(5, 20, 22, 24);
      ctx.stroke();

      ctx.fillStyle = "#FF0000";
      ctx.fillRect(-8, -10, 16, 18);

      ctx.fillStyle = "#FCD7B6";
      ctx.beginPath();
      ctx.arc(0, -16, 7, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = "#FF0000";
      ctx.beginPath();
      ctx.moveTo(-7, -19);
      ctx.lineTo(0, -28);
      ctx.lineTo(7, -19);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle = "#FFFFFF";
      ctx.beginPath();
      ctx.arc(0, -28, 3, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(0, -20, 7.5, Math.PI, 0);
      ctx.fill();

      ctx.beginPath();
      ctx.moveTo(-5, -12);
      ctx.quadraticCurveTo(0, -6, 5, -12);
      ctx.quadraticCurveTo(0, -3, -5, -12);
      ctx.fill();

      ctx.fillStyle = "#006400";
      ctx.beginPath();
      ctx.ellipse(-20, -2, 10, 14, 0, 0, Math.PI * 2);
      ctx.fill();

      ctx.restore();
    }

    function drawSantaImg(x, y) {
      if (santaLoaded) {
        const targetWidth = 80; // lebar tampilan Santa
        const ratio = santaImg.height / santaImg.width;
        const targetHeight = targetWidth * ratio;
        ctx.drawImage(
          santaImg,
          x - targetWidth / 2,
          y - targetHeight / 2,
          targetWidth,
          targetHeight
        );
      } else {
        drawSantaVector(x, y);
      }
    }

    function drawCandyPipe(x, y, w, h) {
      ctx.fillStyle = "#228B22";
      ctx.fillRect(x, y, w, h);

      ctx.fillStyle = "#DC143C";
      for (let i = 0; i < h; i += 26) {
        ctx.fillRect(x, y + i, w, 13);
      }

      ctx.strokeStyle = "white";
      ctx.lineWidth = 5;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.beginPath();
      ctx.moveTo(x + 15, y + 15);
      ctx.quadraticCurveTo(x + 35, y + h / 2, x + 15, y + h - 15);
      ctx.stroke();
    }

    function drawBackground() {
      const grad = ctx.createLinearGradient(0, 0, 0, 600);
      grad.addColorStop(0, "#020617");
      grad.addColorStop(0.5, "#1e3a8a");
      grad.addColorStop(1, "#082f49");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, 400, 600);

      ctx.fillStyle = "#fff";
      for (let i = 0; i < 40; i++) {
        ctx.fillRect((i * 137.5) % 400, (i * 61) % 400, 2, 2);
      }
    }

    function drawStart() {
      ctx.fillStyle = "rgba(0,0,0,0.65)";
      ctx.fillRect(50, 150, 300, 300);
      ctx.fillStyle = "#FFD700";
      ctx.font = "bold 30px Arial";
      ctx.textAlign = "center";
      ctx.fillText("Xmas Flappy Santa", 200, 220);
      ctx.fillStyle = "white";
      ctx.font = "20px Arial";
      ctx.fillText("Connect wallet to play!", 200, 280);
      ctx.fillText("Tap / Space to fly", 200, 315);
    }

    function drawGameOver() {
      ctx.fillStyle = "rgba(0,0,0,0.8)";
      ctx.fillRect(40, 120, 320, 360);
      ctx.fillStyle = "#c41e3a";
      ctx.font = "bold 36px Arial";
      ctx.textAlign = "center";
      ctx.fillText("Game Over", 200, 190);
      ctx.fillStyle = "white";
      ctx.font = "bold 24px Arial";
      ctx.fillText(`Score: ${score}`, 200, 240);
      ctx.fillText(`Best: ${best}`, 200, 275);
      ctx.font = "18px Arial";
      ctx.fillText("Tap/Space = Restart", 200, 320);
      ctx.fillText("Use 'Save Score' to record", 200, 350);
    }

    // ===== GAME LOOP =====
    function gameLoop() {
      ctx.clearRect(0, 0, 400, 600);
      frame++;

      drawBackground();

      if (frame % 2 === 0) {
        snowflakes.push({
          x: Math.random() * 400,
          y: -5,
          s: Math.random() * 3 + 1.5,
          vy: Math.random() * 0.4 + 0.4,
        });
      }

      snowflakes = snowflakes.filter((s) => {
        s.y += s.vy;
        s.x += Math.sin(frame * 0.01 + s.y) * 0.3;
        return s.y < 610;
      });

      snowflakes.forEach((s) => {
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.s, 0, Math.PI * 2);
        ctx.fill();
      });

      if (!started) {
        drawStart();
        submitBtn.style.display = "none";
        requestAnimationFrame(gameLoop);
        return;
      }

      if (gameOver) {
        drawGameOver();
        if (walletConnected && score > playerBest) {
          submitBtn.style.display = "inline-block";
        } else {
          submitBtn.style.display = "none";
        }
        requestAnimationFrame(gameLoop);
        return;
      }

      submitBtn.style.display = "none";

      bird.vy *= 0.96;
      bird.vy += GRAVITY;
      bird.y += bird.vy;

      if (bird.y < 15 || bird.y > 570) {
        gameOver = true;
        playSafe(hitSound);
      }

      drawSantaImg(bird.x, bird.y);

      if (frame % PIPE_INTERVAL === 0) {
        const gapTop = 80 + Math.random() * 210;
        pipes.push({
          x: 410,
          top: gapTop,
          bottom: 600 - gapTop - PIPE_GAP,
          passed: false,
        });
      }

      pipes = pipes.filter((p) => {
        p.x -= PIPE_SPEED;

        if (p.x < -70) return false;

        if (p.x + 70 < bird.x && !p.passed) {
          score++;
          document.getElementById("score").textContent = score;
          p.passed = true;
          playSafe(scoreSound);
        }

        if (
          bird.x - 40 < p.x + 65 &&
          bird.x + 40 > p.x &&
          (bird.y - 30 < p.top || bird.y + 30 > p.top + PIPE_GAP)
        ) {
          gameOver = true;
          playSafe(hitSound);
        }

        drawCandyPipe(p.x, 0, 65, p.top);
        drawCandyPipe(p.x, p.top + PIPE_GAP, 65, p.bottom);

        return true;
      });

      if (score > best) {
        best = score;
        document.getElementById("best").textContent = best;
      }

      requestAnimationFrame(gameLoop);
    }

    function flap() {
      if (!walletConnected) {
        alert("Please connect your Somnia wallet first to play.");
        return;
      }

      // mulai musik pada interaksi pertama
      startMusicOnce();

      if (!started) {
        started = true;
        gameOver = false;
        return;
      }

      if (gameOver) {
        bird.y = 300;
        bird.vy = 0;
        score = 0;
        pipes = [];
        snowflakes = [];
        document.getElementById("score").textContent = "0";
        gameOver = false;
        submitBtn.style.display = "none";
        return;
      }

      bird.vy = FLAP_POWER;
      playSafe(flapSound);
    }

    canvas.addEventListener("click", flap);
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space") {
        e.preventDefault();
        flap();
      }
    });

    document.getElementById("toggle-lb").onclick = () => {
      const box = document.getElementById("leaderboard");
      const willShow =
        box.style.display === "none" || box.style.display === "";
      box.style.display = willShow ? "block" : "none";
      if (willShow) loadLeaderboard();
    };

    document.getElementById("connect").onclick = async () => {
      if (!window.viem) return alert("Loading... coba lagi");
      const { createWalletClient, custom, createPublicClient, http } = window.viem;

      if (!window.ethereum) return alert("Install MetaMask dulu, bro!");

      try {
        walletClient = createWalletClient({
          chain: somnia,
          transport: custom(window.ethereum),
        });

        await walletClient.switchChain({ id: 5031n });

        [account] = await walletClient.requestAddresses();

        publicClient = createPublicClient({
          chain: somnia,
          transport: http(somnia.rpcUrls.default.http[0]),
        });

        if (account && account.length > 10) {
          walletConnected = true;

          document.getElementById("connect").textContent =
            `${account.slice(0, 6)}...${account.slice(-4)}`;

          playerBest = Number(
            await publicClient.readContract({
              address: CONTRACT_ADDRESS,
              abi: ABI,
              functionName: "getPlayerBest",
              args: [account],
            })
          );

          best = Math.max(best, playerBest);
          document.getElementById("best").textContent = best;
        } else {
          alert("Wallet connect gagal");
        }
      } catch (e) {
        console.error(e);
        alert(`Connect error: ${e.message}`);
      }
    };

    async function loadLeaderboard() {
      if (!publicClient) return;
      try {
        const lb = await publicClient.readContract({
          address: CONTRACT_ADDRESS,
          abi: ABI,
          functionName: "getLeaderboard",
        });

        const list = document.getElementById("lb-list");
        list.innerHTML = "";

        if (!lb || lb.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No scores on chain yet.";
          list.appendChild(li);
          return;
        }

        lb.slice(0, 10).forEach((p, i) => {
          const addr = String(p[0]);
          const short = addr.slice(0, 6) + "..." + addr.slice(-4);
          const li = document.createElement("li");
          li.textContent = `${i + 1}. ${short} — ${Number(p[1])} pts`;
          list.appendChild(li);
        });
      } catch (e) {
        console.error("loadLeaderboard error", e);
        const list = document.getElementById("lb-list");
        list.innerHTML = "";
        const li = document.createElement("li");
        li.textContent = "Failed to load leaderboard.";
        list.appendChild(li);
      }
    }

    async function submitScoreToChain() {
      if (!walletConnected || !window.ethereum) {
        alert("Wallet not connected.");
        return;
      }
      if (score <= playerBest) {
        alert("Your score is not higher than your best on-chain score.");
        return;
      }

      const ok = confirm(`Submit score ${score} to on-chain leaderboard?`);
      if (!ok) return;

      try {
        const { encodeFunctionData } = window.viem;
        const data = encodeFunctionData({
          abi: ABI,
          functionName: "submitScore",
          args: [BigInt(score)],
        });

        const txHash = await window.ethereum.request({
          method: "eth_sendTransaction",
          params: [
            {
              from: account,
              to: CONTRACT_ADDRESS,
              data,
            },
          ],
        });

        alert(`Score ${score} submitted! Tx: ${txHash.slice(0, 12)}...`);
        playerBest = score;
        best = Math.max(best, playerBest);
        document.getElementById("best").textContent = best;
        await loadLeaderboard();
      } catch (e) {
        console.error(e);
        alert(`Submit gagal: ${e.message}`);
      }
    }

    submitBtn.onclick = submitScoreToChain;

    gameLoop();
  </script>
</body>
</html>