<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xmas Flappy Reindeer - Somnia</title>
  <script type="module">
    import { createPublicClient, createWalletClient, custom, http } from 'https://cdn.jsdelivr.net/npm/viem@2.0.0/+esm';
    window.viem = { createPublicClient, createWalletClient, custom, http };
  </script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#0a1a3f; overflow:hidden; font-family:Arial; color:white; }
    canvas { display:block; margin:0 auto; }
    #ui { position:absolute; top:20px; left:20px; z-index:10; }
    #leaderboard { position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.7); padding:15px; border-radius:10px; max-width:280px; }
    button { padding:12px 24px; font-size:16px; background:#c41e3a; color:white; border:none; border-radius:8px; cursor:pointer; }
    h2,h3 { margin:10px 0; }
    ol { font-size:14px; }
  </style>
</head>
<body>
  <div id="ui">
    <button id="connect">Connect Wallet</button>
    <h2>Score: <span id="score">0</span></h2>
    <h3>Best: <span id="best">0</span></h3>
  </div>
  <canvas id="game" width="400" height="600"></canvas>
  <div id="leaderboard" style="display:none;">
    <h3>Top 10 Flyers</h3>
    <ol id="lb-list"></ol>
  </div>

<script type="module">
const CONTRACT_ADDRESS = "0x94b28B4194aA9D9b6397878AfA7456b9F4c3cf45";
const ABI = [
  {"inputs":[{"internalType":"uint256","name":"_score","type":"uint256"}],"name":"submitScore","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"getLeaderboard","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"score","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct XmasFlappyLeaderboard.Player[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerBest","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
];

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let score = 0, best = 0, gameOver = true, started = false;
let bird = { x: 100, y: 300, vy: 0 };
let pipes = [];
let snowflakes = [];
let frame = 0;
let playerBest = 0;
let walletClient, publicClient, account;

const somnia = { id: 5031n, name: 'Somnia Mainnet', rpcUrls: { default: { http: ['https://api.infra.mainnet.somnia.network'] } } };

function drawReindeer(x, y) {
  ctx.save(); ctx.translate(x, y);
  ctx.fillStyle = '#8B4513'; ctx.beginPath(); ctx.ellipse(0,0,22,16,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = '#D2691E'; ctx.beginPath(); ctx.arc(-12,-3,10,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(-16,-4,3,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(-8,-4,3,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(-16,-5,1.5,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(-8,-5,1.5,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = '#FF0000'; ctx.beginPath(); ctx.arc(-3,0,5,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#DAA520'; ctx.lineWidth = 4; ctx.lineCap = 'round';
  ctx.beginPath(); ctx.moveTo(-20,-10); ctx.lineTo(-28,-22); ctx.lineTo(-25,-28); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(-14,-10); ctx.lineTo(-22,-24); ctx.lineTo(-19,-30); ctx.stroke();
  ctx.restore();
}

function drawCandyPipe(x, y, w, h) {
  ctx.fillStyle = '#228B22'; ctx.fillRect(x, y, w, h);
  ctx.fillStyle = '#DC143C';
  for (let i = 0; i < h; i += 25) ctx.fillRect(x, y + i, w, 12);
  ctx.strokeStyle = 'white'; ctx.lineWidth = 5; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
  ctx.beginPath(); ctx.moveTo(x + 15, y + 15); ctx.quadraticCurveTo(x + 35, y + h/2, x + 15, y + h - 15); ctx.stroke();
}

function drawBackground() {
  const grad = ctx.createLinearGradient(0,0,0,600);
  grad.addColorStop(0,'#0a1a3f'); grad.addColorStop(0.5,'#1e3a8a'); grad.addColorStop(1,'#16213e');
  ctx.fillStyle = grad; ctx.fillRect(0,0,400,600);
  ctx.fillStyle = '#fff'; for(let i=0; i<40; i++) { ctx.fillRect((i*137.5)%400, (i*61)%400, 2,2); }
}

function drawStart() {
  ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fillRect(50,150,300,300);
  ctx.fillStyle = '#FFD700'; ctx.font = 'bold 32px Arial'; ctx.textAlign = 'center'; ctx.fillText('Xmas Flappy', 200, 220);
  ctx.font = 'bold 28px Arial'; ctx.fillText('Reindeer', 200, 260);
  ctx.fillStyle = 'white'; ctx.font = '20px Arial';
  ctx.fillText('Click/Space to Fly!', 200, 320);
  ctx.fillText('Dodge Candy Canes!', 200, 355);
}

function drawGameOver() {
  ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.fillRect(40,120,320,360);
  ctx.fillStyle = '#c41e3a'; ctx.font = 'bold 36px Arial'; ctx.textAlign = 'center';
  ctx.fillText('Game Over', 200, 190);
  ctx.fillStyle = 'white'; ctx.font = 'bold 24px Arial';
  ctx.fillText(`Score: ${score}`, 200, 240);
  ctx.fillText(`Best: ${best}`, 200, 275);
  ctx.font = '20px Arial';
  ctx.fillText('Click/Space Restart', 200, 330);
}

// Game loop
function gameLoop() {
  ctx.clearRect(0,0,400,600); frame++;
  drawBackground();

  if (frame % 2 === 0) snowflakes.push({x: Math.random()*400, y:-5, s: Math.random()*3+1.5, vy: Math.random()*0.5+0.5});
  snowflakes = snowflakes.filter(s => { s.y += s.vy; s.x += Math.sin(frame*0.01 + s.y)*0.5; return s.y < 610; });
  snowflakes.forEach(s => { ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(s.x,s.y,s.s,0,Math.PI*2); ctx.fill(); });

  if (!started) { drawStart(); requestAnimationFrame(gameLoop); return; }
  if (gameOver) { drawGameOver(); requestAnimationFrame(gameLoop); return; }

  bird.vy *= 0.95; bird.vy += 0.55; bird.y += bird.vy;
  if (bird.y < 20 || bird.y > 560) gameOver = true;
  drawReindeer(bird.x, bird.y);

  if (frame % 85 === 0) {
    const gapTop = 80 + Math.random() * 220;
    pipes.push({x: 410, top: gapTop, bottom: 600 - gapTop - 160, passed: false});
  }
  pipes = pipes.filter(p => {
    p.x -= 3.2;
    if (p.x < -70) return false;
    if (p.x + 70 < bird.x && !p.passed) { score++; document.getElementById('score').textContent = score; p.passed = true; }
    if (bird.x < p.x + 65 && bird.x + 40 > p.x && (bird.y < p.top || bird.y + 40 > p.top + 155)) { gameOver = true; }
    drawCandyPipe(p.x, 0, 65, p.top);
    drawCandyPipe(p.x, p.top + 155, 65, p.bottom);
    return true;
  });

  if (score > best) { best = score; document.getElementById('best').textContent = best; }
  requestAnimationFrame(gameLoop);
}

function flap() {
  if (!started) { started = true; }
  else if (gameOver) { bird.y = 300; bird.vy = 0; score = 0; pipes = []; snowflakes = []; document.getElementById('score').textContent = '0'; }
  else { bird.vy = -11; }
  gameOver = false;
}
canvas.addEventListener('click', flap);
document.addEventListener('keydown', e => { if (e.code === 'Space') { e.preventDefault(); flap(); } });

// Connect Wallet
document.getElementById('connect').onclick = async () => {
  if (!window.viem) return alert('viem loading... try again');
  const { createWalletClient, custom, createPublicClient, http } = window.viem;
  if (!window.ethereum) return alert('Install MetaMask!');
  try {
    walletClient = createWalletClient({ chain: somnia, transport: custom(window.ethereum) });
    await walletClient.switchChain({ id: 5031n });
    [account] = await walletClient.requestAddresses();
    publicClient = createPublicClient({ chain: somnia, transport: http() });
    
    // FIX ERROR: Cek account dulu sebelum slice
    if (account) {
      document.getElementById('connect').textContent = `\( {account.slice(0,6)}... \){account.slice(-4)}`;
    }
    
    playerBest = Number(await publicClient.readContract({ address: CONTRACT_ADDRESS, abi: ABI, functionName: 'getPlayerBest', args: [account] }));
    loadLeaderboard();
  } catch (e) { alert(`Connect gagal: ${e.message}`); }
};

async function loadLeaderboard() {
  if (!publicClient || !account) return;
  try {
    const lb = await publicClient.readContract({ address: CONTRACT_ADDRESS, abi: ABI, functionName: 'getLeaderboard' });
    const list = document.getElementById('lb-list'); list.innerHTML = '';
    lb.slice(0,10).forEach((p, i) => {
      const short = p[0].slice(0,6) + '...' + p[0].slice(-4);
      const li = document.createElement('li');
      li.textContent = `\( {i+1}. \){short} â€” ${Number(p[1])} pts`;
      list.appendChild(li);
    });
    document.getElementById('leaderboard').style.display = 'block';
  } catch (e) {}
}

async function submitScoreToChain() {
  if (!walletClient || score <= playerBest) return;
  try {
    const hash = await walletClient.writeContract({
      address: CONTRACT_ADDRESS,
      abi: ABI,
      functionName: 'submitScore',
      args: [BigInt(score)]
    });
    alert(`Score \( {score} submitted! Tx: \){hash.slice(0,12)}...`);
    playerBest = score;
    loadLeaderboard();
  } catch (e) { alert(`Submit gagal: ${e.message}`); }
}

const oldDrawGameOver = drawGameOver;
drawGameOver = function() {
  oldDrawGameOver();
  if (score > playerBest && walletClient) setTimeout(submitScoreToChain, 500);
};

gameLoop();
</script>
</body>
</html>